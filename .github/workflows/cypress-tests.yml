name: Cypress Tests

on: push

jobs:
  cypress-run:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Cypress run
        uses: cypress-io/github-action@v7

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          STATUS="${{ job.status }}"
          REPO="${{ github.repository }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref }}"
          COMMIT="${{ github.sha }}"
          PAYLOAD="{\"content\":\"Build status: ${STATUS}\nRepository: ${REPO}\nBranch: ${BRANCH}\nCommit: ${COMMIT}\nRun: ${RUN_URL}\"}"
          echo "--- Discord notify debug ---"
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK secret is NOT set. No notification will be sent."
            echo "Set the secret in Settings → Secrets → Actions with your webhook URL and re-run the workflow."
            exit 0
          fi
          echo "Payload: $PAYLOAD"
          echo "Sending notification to Discord..."
          HTTP_RESPONSE=$(curl -s -o /tmp/discord_resp -w "%{http_code}" -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK" || true)
          echo "HTTP status: $HTTP_RESPONSE"
          echo "Discord response body:" && cat /tmp/discord_resp || true
          echo "--- end debug ---"